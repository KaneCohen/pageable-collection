/**
 * Backbone - Pageable Collection. Simple paginator on top of Collection.
 * version 0.1.2
 * Kane Cohen [KaneCohen@gmail.com] | https://github.com/KaneCohen
 * @preserve
 */
!function(factory){"function"==typeof define&&define.amd?define(["underscore","backbone"],factory):factory(_,Backbone)}(function(_,Backbone){var PageableCollection=Backbone.PageableCollection=Backbone.Collection.extend({mode:"server",style:!1,headerState:!1,items:null,cache:!1,cachedPages:{},presenter:null,linkUrl:null,ajaxLoad:!0,updateUrl:!0,state:{},defaultState:{currentPage:1,firstPage:1,lastPage:0,perPage:20,total:0},params:{},defaultParams:{currentPage:"page",offset:!1,perPage:!1,sortParam:"sort",sortBy:!1,orderParam:"order",orderBy:!1},constructor:function(models,options){Backbone.Collection.apply(this,arguments),options||(options={}),options.url&&(this.url=options.url),options.model&&(this.model=options.model),"undefined"!=typeof options.comparator&&(this.comparator=options.comparator),this.state=_.extend({},this.defaultState,this.state,options.state),this.params=_.extend({},this.defaultParams,this.params,options.params),this.state.currentPage=this.getParam(this.params.currentPage,this.state.firstPage),this.mode=options.mode||this.mode,this.items=new(Backbone.Collection.extend({model:this.model})),this.updateState(),this.presenter||this.initPresenter()},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;l>i;i++)this._removeReference(this.models[i]);return options.previousModels=this.models,this._reset(),models=this.add(models,_.extend({silent:!0},options)),this.updateState(),options.silent||this.trigger("reset",this,options),models},parse:function(resp,options){var items=resp;return _.isObject(resp)&&_.has(resp,"state")&&_.has(resp,"items")&&(_.extend(this.state,resp.state),items=resp.items),this.headerState&&(options.xhr.getResponseHeader("X-PerPage")&&(this.state.perPage=options.xhr.getResponseHeader("X-PerPage")),options.xhr.getResponseHeader("X-CurrentPage")&&(this.state.currentPage=options.xhr.getResponseHeader("X-CurrentPage")),options.xhr.getResponseHeader("X-Total")&&(this.state.total=options.xhr.getResponseHeader("X-Total"))),items},updateState:function(){this.state.total=isNaN(this.state.total)?0:parseInt(this.state.total,10),this.state.perPage=!isNaN(this.state.perPage)&&this.state.perPage>0?parseInt(this.state.perPage,10):20,this.state.firstPage=!isNaN(this.state.firstPage)&&this.state.firstPage>0?parseInt(this.state.firstPage,10):1,this.state.lastPage=this.state.total>0?Math.ceil(this.state.total/this.state.perPage):0,this.state.currentPage=isNaN(this.state.currentPage)?this.state.firstPage:parseInt(this.state.currentPage,10),this.state.total>0&&!isNaN(this.state.currentPage)&&this.state.currentPage>this.state.lastPage&&(this.state.currentPage=this.state.lastPage>0?this.state.lastPage:1)},getMode:function(){return this.mode},setMode:function(mode){return _.contains(["client","server"],mode)&&(this.mode=mode,this.updateState()),this},getCurrentPage:function(){return this.state.currentPage},setCurrentPage:function(page){return this.state.currentPage=page,this.updateState(),this},getFirstPage:function(){return this.state.firstPage},setFirstPage:function(page){return this.state.firstPage=page,this.updateState(),this},getLastPage:function(){return this.state.lastPage},getNextPage:function(){return this.hasNextPage()?this.state.currentPage+1:null},getPrevPage:function(){return this.hasPrevPage()?this.state.currentPage-1:null},getPerPage:function(){return this.state.perPage},setPerPage:function(size){return this.state.perPage=size,this.updateState(),this},setSort:function(param){return this.params.sortParam=param,this.updateState(),this},setOrder:function(order){return this.params.sortOrder=order,this.updateState(),this},setSearch:function(){return this.params.sortOrder=order,this.updateState(),this},getOffset:function(page){page||(page=this.state.currentPage);var offset=(page-1)*this.state.perPage;return"server"==this.mode&&(offset=0),offset},getItems:function(){this.items||(this.items=new(Backbone.Collection.extend({model:this.model})));var offset=this.getOffset(),models=this.slice(offset,offset+this.state.perPage);return this.items.reset(models,{silent:!0}),this.items},fetchPage:function(page,options){options=options?_.clone(options):{},"undefined"==typeof options.parse&&(options.parse=!0),options.url=this.getPaginatorUrl(page);var deferred=Backbone.$.Deferred(),method=options.reset?"reset":"set";if(this.state.currentPage=page,"server"==this.mode){if(!this.cache||"undefined"==typeof this.cachedPages[page])return this.fetch(options);var models=collection.cachedPages[page];this[method](models,options),deferred.resolve(this.models)}else"client"==this.mode&&(this.trigger(method,this),deferred.resolve(this.models));return wrapError(this,options),deferred.promise()},fetchNextPage:function(options){return this.hasNextPage()?this.fetchPage(this.state.currentPage+1,options):void 0},fetchPrevPage:function(options){return this.hasPrevPage()?this.fetchPage(this.state.currentPage-1,options):void 0},fetchFirstPage:function(options){return this.state.currentPage!==this.state.firstPage?this.fetchPage(this.state.firstPage,options):void 0},fetchLastPage:function(options){return this.state.lastPage>0&&this.state.currentPage!=this.state.lastPage?this.fetchPage(this.state.lastPage,options):void 0},queryParams:function(){var query=location.search.slice(1);query=query.split("&");var params={};return _.each(query,function(v){var param=v.split("=");params[param[0]]=param[1]}),params},getParam:function(key,def){var params=this.queryParams();return"undefined"==typeof params[key]?def||null:params[key]},clearCache:function(){return this.cachedPages={},this},hasNextPage:function(){return 0!==this.state.total?this.state.currentPage<this.state.lastPage:"server"==this.mode?this.state.perPage<this.length:"client"==this.mode?this.getOffset()+this.state.perPage<this.length:void 0},hasPrevPage:function(){return this.state.currentPage-1>=this.state.firstPage},getPaginatorUrl:function(page,link){var params={};params[this.params.currentPage]=page,this.params.offset&&(params[this.params.offset]=this.getOffset(page)),this.params.perPage&&(params[this.params.perPage]=this.state.perPage),this.params.sortBy&&(params[this.params.sortParam]=this.params.sortBy),this.params.orderBy&&(params[this.params.orderParam]=this.params.orderBy);var queryString="";return _.each(_.pairs(params),function(v,k){k>0&&(queryString+="&"),queryString+=v.join("=")}),link?(this.linkUrl||this.url||"")+"?"+queryString:(this.url||"")+"?"+queryString},links:function(){return _.contains(["pager","links","infinite"],this.style)?this[this.style]():(new this.presenter).render()},pager:function(){return(new this.presenter).pager()},slider:function(){return(new this.presenter).slider()},infinite:function(container){return(new this.presenter).infinite(container)},setPresenter:function(presenter){return presenter.collection=this,this.presenter=presenter,this},getPresenter:function(){return this.presenter},initPresenter:function(){this.presenter=Backbone.View.extend({collection:this,tagName:"ul",className:"pager",container:null,initialize:function(){this.collection.ajaxLoad&&(this.undelegateEvents(),this.delegateEvents({"click a":"openPage"}))},render:function(){return this.collection.state.total>0?this.pager():this.slider()},pager:function(){var content="";return this.collection.state.lastPage>1&&(content=this.collection.state.lastPage<13?this.getPageRange(1,this.collection.state.lastPage):this.getPagination()),this.$el.html(this.getPrevLink()+content+this.getNextLink())},slider:function(){return this.$el.html(this.getPrevLink()+this.getNextLink())},infinite:function(){return this.$el.html(this.getMoreLink())},openPage:function(e){var page=parseInt(e.currentTarget.getAttribute("data-page"),10);return this.collection.fetchPage(page,{reset:!0}),e.preventDefault(),!1},getPrevLink:function(){return this.collection.hasPrevPage()?'<li class="page-prev"><a href="'+this.collection.getPaginatorUrl(this.collection.state.currentPage-1,!0)+'" data-page="'+(this.collection.state.currentPage-1)+'"><i class="icon icon-arrow-left"></i></a></li>':""},getNextLink:function(){return this.collection.hasNextPage()?'<li class="page-next"><a href="'+this.collection.getPaginatorUrl(this.collection.state.currentPage+1,!0)+'" data-page="'+(this.collection.state.currentPage+1)+'"><i class="icon icon-arrow-right"></i></a></li>':""},getMoreLink:function(){return this.collection.hasNextPage()?'<li class="page-more"><a href="'+this.collection.getPaginatorUrl(this.collection.state.currentPage+1,!0)+'" data-page="'+(this.collection.state.currentPage+1)+'">More</a></li>':""},getPageRange:function(start,end){for(var pages=[],page=start;end>=page;page++)this.collection.state.currentPage==page?pages.push('<li class="active">'+this.getLink(page)+"</li>"):pages.push("<li>"+this.getLink(page)+"</li>");return pages.join("")},getPagination:function(){var ending,start,content,w=6;return this.collection.state.currentPage<=w?(ending=this.getFinish(),this.getPageRange(1,w+2)+ending):this.collection.state.currentPage>=this.collection.state.lastPage-w?(start=this.collection.state.lastPage-8,content=this.getPageRange(start,this.collection.state.lastPage),this.getStart()+content):(content=this.getAdjacentRange(),this.getStart()+content+this.getFinish())},getLink:function(page){return'<a href="'+this.collection.getPaginatorUrl(page,!0)+'" data-page="'+page+'">'+page+"</a>"},getAdjacentRange:function(){return start=this.collection.state.currentPage-3,this.getPageRange(start,this.collection.state.currentPage+3)},getStart:function(){return this.getPageRange(1,2)+this.getDots()},getFinish:function(){var content=this.getPageRange(this.collection.state.lastPage-1,this.collection.state.lastPage);return this.getDots()+content},getDots:function(){return'<li class="disabled"><a href="#">...</a></li>'}})}}),wrapError=function(model,options){var error=options.error;options.error=function(resp){error&&error(model,resp,options),model.trigger("error",model,resp,options)}};return PageableCollection});