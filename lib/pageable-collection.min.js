/**
 * Backbone - Pageable Collection. Simple paginator on top of Collection.
 * version 0.2.2
 * Kane Cohen [KaneCohen@gmail.com] | https://github.com/KaneCohen
 * @preserve
 */
!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone"],b):"object"==typeof exports?module.exports=b(_,Backbone):a.returnExports=b(_,Backbone)}(this,function(a,b){function c(a){return"function"==typeof a?a():a}var d=b.PageableCollectionPresenterMixin={collection:null,tagName:"ul",className:"pager",container:null,events:function(){return this.collection.ajaxLoad?{"click a":"openPage"}:void 0},initialize:function(a){return this.collection=a,this},links:function(){return this.collection.state.total>0?this.pager():this.slider(),this},pager:function(){var a="";return this.collection.state.lastPage>1&&(a=this.collection.state.lastPage<13?this.getPageRange(1,this.collection.state.lastPage):this.getPagination()),this.$el.html(this.getPrevLink()+a+this.getNextLink()),this},slider:function(){return this.$el.html(this.getPrevLink()+this.getNextLink()),this},infinite:function(){return this.$el.html(this.getMoreLink()),this},openPage:function(a){var b=parseInt(a.currentTarget.getAttribute("data-page"),10);return this.collection.fetchPage(b,{reset:!0}),a.preventDefault(),!1},getPrevLink:function(){return this.collection.hasPrevPage()?'<li class="page-prev"><a href="'+this.collection.getPaginatorUrl(this.collection.state.currentPage-1,!0)+'" data-page="'+(this.collection.state.currentPage-1)+'"><i class="icon icon-arrow-left"></i></a></li>':""},getNextLink:function(){return this.collection.hasNextPage()?'<li class="page-next"><a href="'+this.collection.getPaginatorUrl(this.collection.state.currentPage+1,!0)+'" data-page="'+(this.collection.state.currentPage+1)+'"><i class="icon icon-arrow-right"></i></a></li>':""},getMoreLink:function(){return this.collection.hasNextPage()?'<li class="page-more"><a href="'+this.collection.getPaginatorUrl(this.collection.state.currentPage+1,!0)+'" data-page="'+(this.collection.state.currentPage+1)+'">More</a></li>':""},getPageRange:function(a,b){for(var c=[],d=a;b>=d;d++)c.push(this.collection.state.currentPage==d?'<li class="active">'+this.getLink(d)+"</li>":"<li>"+this.getLink(d)+"</li>");return c.join("")},getPagination:function(){var a,b,c,d=6;return this.collection.state.currentPage<=d?(a=this.getFinish(),this.getPageRange(1,d+2)+a):this.collection.state.currentPage>=this.collection.state.lastPage-d?(b=this.collection.state.lastPage-8,c=this.getPageRange(b,this.collection.state.lastPage),this.getStart()+c):(c=this.getAdjacentRange(),this.getStart()+c+this.getFinish())},getLink:function(a){return'<a href="'+this.collection.getPaginatorUrl(a,!0)+'" data-page="'+a+'">'+a+"</a>"},getAdjacentRange:function(){return start=this.collection.state.currentPage-3,this.getPageRange(start,this.collection.state.currentPage+3)},getStart:function(){return this.getPageRange(1,2)+this.getDots()},getFinish:function(){var a=this.getPageRange(this.collection.state.lastPage-1,this.collection.state.lastPage);return this.getDots()+a},getDots:function(){return'<li class="disabled"><a href="#">...</a></li>'}},e=b.View.extend(d),f=b.PageableCollection=b.Collection.extend({mode:"server",style:!1,headerState:!1,cache:!1,cachedPages:{},presenter:null,linkUrl:null,ajaxLoad:!0,updateUrl:!0,state:{},defaultState:{currentPage:1,firstPage:1,lastPage:0,perPage:20,total:0},appendParams:!0,params:{},defaultParams:{currentPage:"page",offset:!1,perPage:!1,sortParam:"sort",sortBy:!1,orderParam:"order",orderBy:!1},constructor:function(c,d){b.Collection.apply(this,arguments),d||(d={}),d.url&&(this.url=d.url),d.model&&(this.model=d.model),"undefined"!=typeof d.comparator&&(this.comparator=d.comparator),this.state=a.extend({},this.defaultState,this.state,d.state),this.params=a.extend({},this.defaultParams,this.params,d.params),this.state.currentPage=this.getParam(this.params.currentPage,this.state.firstPage),this.mode=d.mode||this.mode,this.updateState(),this.presenter||this.setPresenter(e)},setState:function(b){this.state=a.extend({},this.state,b),this.updateState()},reset:function(b,c){c||(c={});for(var d=0,e=this.models.length;e>d;d++)this._removeReference(this.models[d]);return c.previousModels=this.models,this._reset(),b=this.add(b,a.extend({silent:!0},c)),this.updateState(),c.silent||this.trigger("reset",this,c),b},parse:function(b,c){var d=b;return a.isObject(b)&&a.has(b,"state")&&a.has(b,"items")&&(a.extend(this.state,b.state),d=b.items),this.headerState&&(c.xhr.getResponseHeader("X-PerPage")&&(this.state.perPage=c.xhr.getResponseHeader("X-PerPage")),c.xhr.getResponseHeader("X-CurrentPage")&&(this.state.currentPage=c.xhr.getResponseHeader("X-CurrentPage")),c.xhr.getResponseHeader("X-Total")&&(this.state.total=c.xhr.getResponseHeader("X-Total"))),d},updateState:function(){this.state.total=isNaN(this.state.total)?0:parseInt(this.state.total,10),this.state.perPage=!isNaN(this.state.perPage)&&this.state.perPage>0?parseInt(this.state.perPage,10):20,this.state.firstPage=!isNaN(this.state.firstPage)&&this.state.firstPage>0?parseInt(this.state.firstPage,10):1,this.state.lastPage=this.state.total>0?Math.ceil(this.state.total/this.state.perPage):0,this.state.currentPage=isNaN(this.state.currentPage)?this.state.firstPage:parseInt(this.state.currentPage,10),this.state.total>0&&!isNaN(this.state.currentPage)&&this.state.currentPage>this.state.lastPage&&(this.state.currentPage=this.state.lastPage>0?this.state.lastPage:1)},getMode:function(){return this.mode},setMode:function(b){return a.contains(["client","server"],b)&&(this.mode=b,this.updateState()),this},getCurrentPage:function(){return this.state.currentPage},setCurrentPage:function(a){return this.state.currentPage=a,this.updateState(),this},getFirstPage:function(){return this.state.firstPage},setFirstPage:function(a){return this.state.firstPage=a,this.updateState(),this},getLastPage:function(){return this.state.lastPage},getNextPage:function(){return this.hasNextPage()?this.state.currentPage+1:null},getPrevPage:function(){return this.hasPrevPage()?this.state.currentPage-1:null},getPerPage:function(){return this.state.perPage},setPerPage:function(a){return this.state.perPage=a,this.updateState(),this},setSort:function(a){return this.params.sortParam=a,this.updateState(),this},setOrder:function(a){return this.params.sortOrder=a,this.updateState(),this},setSearch:function(){return this.params.sortOrder=order,this.updateState(),this},getOffset:function(a){a||(a=this.state.currentPage);var b=(a-1)*this.state.perPage;return"server"==this.mode&&(b=0),b},updateHistory:function(a){var b=document.getElementsByTagName("title"),c=this.getPaginatorUrl(a,!0);b=b?b[0].innerText:"",history.pushState(null,b,c)},fetchPage:function(c,d){d=d?a.clone(d):{},"undefined"==typeof d.parse&&(d.parse=!0),d.url=this.getPaginatorUrl(c);var e=b.$.Deferred(),f=d.reset?"reset":"set";if(this.state.currentPage=c,this.updateUrl&&d.updateUrl!==!1&&this.updateHistory(c),"server"==this.mode){if(!this.cache||"undefined"==typeof this.cachedPages[c])return this.fetch(d);var h=collection.cachedPages[c];this[f](h,d),e.resolve(this.models)}else"client"==this.mode&&(this.trigger(f,this),e.resolve(this.models));return g(this,d),e.promise()},fetchNextPage:function(a){return this.hasNextPage()?this.fetchPage(this.state.currentPage+1,a):void 0},fetchPrevPage:function(a){return this.hasPrevPage()?this.fetchPage(this.state.currentPage-1,a):void 0},fetchFirstPage:function(a){return this.state.currentPage!==this.state.firstPage?this.fetchPage(this.state.firstPage,a):void 0},fetchLastPage:function(a){return this.state.lastPage>0&&this.state.currentPage!=this.state.lastPage?this.fetchPage(this.state.lastPage,a):void 0},queryParams:function(){var b=location.search.slice(1);b=b.split("&");var c={};return a.each(b,function(a){var b=a.split("=");c[b[0]]=b[1]}),c},getParam:function(a,b){var c=this.queryParams();return"undefined"==typeof c[a]?b||null:c[a]},clearCache:function(){return this.cachedPages={},this},hasNextPage:function(){return 0!==this.state.total?this.state.currentPage<this.state.lastPage:"server"==this.mode?this.state.perPage<this.length:"client"==this.mode?this.getOffset()+this.state.perPage<this.length:void 0},hasPrevPage:function(){return this.state.currentPage-1>=this.state.firstPage},getPaginatorUrl:function(b,d){var e=this,f={};f[this.params.currentPage]=b,this.params.offset&&(f[this.params.offset]=this.getOffset(b)),this.params.perPage&&(f[this.params.perPage]=this.state.perPage),this.params.sortBy&&(f[this.params.sortParam]=this.params.sortBy),this.params.orderBy&&(f[this.params.orderParam]=this.params.orderBy);var g="",h=location.search;return e.appendParams?(g=h,0===h.length&&(g+="?")):g+="?",a.each(a.pairs(f),function(a,b){var c="";if(c+=a.join("="),e.appendParams){var d=new RegExp("((&)?"+a[0]+")=(?:\\w+|\\d+)","gi");g=g.replace(d,""),h.length>0&&(g+="&")}else b>0&&(g+="&");g+=c}),d?(c(this.linkUrl)||c(this.url)||"")+g:(c(this.url)||"")+g},links:function(){return a.contains(["pager","links","infinite"],this.style)?this[this.style]():new this.presenter(this).render()},pager:function(){return new this.presenter(this).pager()},slider:function(){return new this.presenter(this).slider()},infinite:function(a){return new this.presenter(this).infinite(a)},setPresenter:function(a){return this.presenter=a,this},getPresenter:function(){return this.presenter}}),g=function(a,b){var c=b.error;b.error=function(d){c&&c(a,d,b),a.trigger("error",a,d,b)}};return f});