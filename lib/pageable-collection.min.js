/**
 * Backbone - Pageable Collection. Simple paginator on top of Collection.
 * version 0.1.0
 * Kane Cohen [KaneCohen@gmail.com] | https://github.com/KaneCohen
 * @preserve
 */
!function(factory){"function"==typeof define&&define.amd?define(["underscore","backbone"],factory):factory(_,Backbone)}(function(_,Backbone){var PageableCollection=Backbone.PageableCollection=Backbone.Collection.extend({mode:"server",style:!1,headerState:!1,items:null,cache:!1,cachedPages:{},presenter:null,linkUrl:null,updateUrl:!0,state:{},baseState:{currentPage:1,firstPage:1,lastPage:0,perPage:20,total:0},params:{},baseParams:{currentPage:"page",offset:!1,perPage:!1,sortParam:"sort",sortBy:!1,orderParam:"order",orderBy:!1},constructor:function(models,options){Backbone.Collection.apply(this,arguments),options||(options={}),options.url&&(this.url=options.url),options.model&&(this.model=options.model),void 0!==options.comparator&&(this.comparator=options.comparator),this.state=_.extend({},this.baseState,this.state,options.state),this.params=_.extend({},this.baseParams,this.params,options.params),this.state.currentPage=this.getParam(this.params.currentPage,this.state.firstPage),this.mode=options.mode||this.mode,this.items=new(Backbone.Collection.extend({model:this.model})),this.presenter||this.initPresenter(),this.updateState()},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;l>i;i++)this._removeReference(this.models[i]);return options.previousModels=this.models,this._reset(),models=this.add(models,_.extend({silent:!0},options)),this.updateState(),options.silent||this.trigger("reset",this,options),models},parse:function(resp,options){var items=resp;return _.isObject(resp)&&_.has(resp,"state")&&_.has(resp,"items")&&(_.extend(this.state,resp.state),items=resp.items),this.headerState&&(this.state.perPage=options.xht.getResponseHeader("X-PerPage"),this.state.currentPage=options.xht.getResponseHeader("X-CurrentPage"),this.state.total=options.xht.getResponseHeader("X-Total")),items},updateState:function(){this.state.total=isNaN(this.state.total)?0:parseInt(this.state.total,10),this.state.perPage=!isNaN(this.state.perPage)&&this.state.perPage>0?parseInt(this.state.perPage,10):20,this.state.firstPage=!isNaN(this.state.firstPage)&&this.state.firstPage>0?parseInt(this.state.firstPage,10):1,this.state.lastPage=this.state.total>0?Math.ceil(this.state.total/this.state.perPage):0,this.state.currentPage=isNaN(this.state.currentPage)?this.state.firstPage:this.state.currentPage,this.state.total>0&&!isNaN(this.state.currentPage)&&this.state.currentPage>this.state.lastPage&&(this.state.currentPage=this.state.lastPage>0?this.state.lastPage:1)},getMode:function(){return this.mode},setMode:function(mode){return _.contains(["client","server"],mode)&&(this.mode=mode,this.updateState()),this},getCurrentPage:function(){return this.state.currentPage},setCurrentPage:function(page){return this.state.currentPage=page,this.updateState(),this},getFirstPage:function(){return this.state.firstPage},setFirstPage:function(page){return this.state.firstPage=page,this.updateState(),this},getLastPage:function(){return this.state.lastPage},getNextPage:function(){return this.hasNextPage()?this.state.currentPage+1:null},getPrevPage:function(){return this.hasPrevPage()?this.state.currentPage-1:null},getPerPage:function(){return this.state.perPage},setPerPage:function(size){return this.state.perPage=size,this.updateState(),this},setSort:function(param){return this.params.sortParam=param,this.updateState(),this},setOrder:function(order){return this.params.sortOrder=order,this.updateState(),this},setSearch:function(){return this.params.sortOrder=order,this.updateState(),this},getOffset:function(page){page||(page=this.state.currentPage);var offset=(page-1)*this.state.perPage;return"server"==this.mode&&(offset=0),offset},getItems:function(){this.items||(this.items=new(Backbone.Collection.extend({model:this.model})));var offset=this.getOffset(),models=this.slice(offset,offset+this.state.perPage);return this.items.reset(models,{silent:!0}),this.items},fetchPage:function(page){return this.state.currentPage=page,"server"==this.mode?this.cache&&void 0!==this.cachedPages[page]?this.reset(this.cachedPages[page]):this.fetch({reset:!0,url:this.getPaginatorUrl(page)}):"client"==this.mode&&this.trigger("reset",this),this},fetchNextPage:function(){return this.hasNextPage()?this.fetchPage(this.state.currentPage+1):void 0},fetchPrevPage:function(){return this.hasPrevPage()?this.fetchPage(this.state.currentPage-1):void 0},fetchFirstPage:function(){return this.state.currentPage!=this.state.firstPage?this.fetchPage(this.state.firstPage):void 0},fetchLastPage:function(){return this.state.lastPage>0&&this.state.currentPage!=this.state.lastPage?this.fetchPage(this.state.lastPage):void 0},queryParams:function(){var query=location.search.slice(1);query=query.split("&");var params={};return _.each(query,function(v){var param=v.split("=");params[param[0]]=param[1]}),params},getParam:function(key,def){var params=this.queryParams();return void 0===params[key]?def||null:params[key]},clearCache:function(){return this.cachedPages={},this},hasNextPage:function(){return 0!==this.state.total?this.state.currentPage<this.state.lastPage:"server"==this.mode?this.state.perPage<this.length:"client"==this.mode?this.getOffset()+this.state.perPage<this.length:void 0},hasPrevPage:function(){return this.state.currentPage-1>=this.state.firstPage},getPaginatorUrl:function(page,link){var params={};params[this.params.currentPage]=page,this.params.offset&&(params[this.params.offset]=this.getOffset(page)),this.params.perPage&&(params[this.params.perPage]=this.state.perPage),this.params.sortBy&&(params[this.params.sortParam]=this.params.sortBy),this.params.orderBy&&(params[this.params.orderParam]=this.params.orderBy);var queryString="";return _.each(_.pairs(params),function(v,k){k>0&&(queryString+="&"),queryString+=v.join("=")}),link?(this.linkUrl||this.url||"")+"?"+queryString:(this.url||"")+"?"+queryString},links:function(){return _.contains(["pager","links","infinite"],this.style)?this[this.style]():this.presenter.render()},pager:function(){return this.presenter.pager()},slider:function(){return this.presenter.slider()},infinite:function(container){return this.presenter.infinite(container)},setPresenter:function(presenter){return this.presenter=presenter,this},getPresenter:function(){return this.presenter},initPresenter:function(){var self=this,View=Backbone.View.extend({className:"pager",container:null,events:{"click a":"openPage"},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this.container&&this.container.off("scroll.delegateEvents"+this.cid),this},render:function(){return self.state.total>0?this.pager():this.slider()},pager:function(){var content="";return self.state.lastPage>1&&(content=self.state.lastPage<13?this.getPageRange(1,self.state.lastPage):this.getPagination()),this.$el.html(this.getPrevLink()+content+this.getNextLink())},slider:function(){return this.$el.html(this.getPrevLink()+this.getNextLink())},infinite:function(){return this.$el.html(this.getMoreLink())},openPage:function(e){var page=parseInt(e.currentTarget.getAttribute("data-page"),10);return self.updateUrl&&"infinite"!=self.mode&&window.history.pushState(null,null,self.getPaginatorUrl(page,!0)),self.fetchPage(page),!1},getPrevLink:function(){return self.hasPrevPage()?'<li class="page-next"><a href="'+self.getPaginatorUrl(self.state.currentPage-1,!0)+'" data-page="'+(self.state.currentPage-1)+'"><i class="icon iconSmallArrowLeft"></i></a></li>':""},getNextLink:function(){return self.hasNextPage()?'<li class="page-next"><a href="'+self.getPaginatorUrl(self.state.currentPage+1,!0)+'" data-page="'+(self.state.currentPage+1)+'"><i class="icon iconSmallArrowRight"></i></a></li>':""},getMoreLink:function(){return self.hasNextPage()?'<li class="page-next page-more"><a href="'+self.getPaginatorUrl(self.state.currentPage+1,!0)+'" data-page="'+(self.state.currentPage+1)+'">More</a></li>':""},getPageRange:function(start,end){for(var pages=[],page=start;end>=page;page++)self.state.currentPage==page?pages.push('<li class="active">'+this.getLink(page)+"</li>"):pages.push("<li>"+this.getLink(page)+"</li>");return pages.join("")},getPagination:function(){var ending,start,content,w=6;return self.state.currentPage<=w?(ending=this.getFinish(),this.getPageRange(1,w+2)+ending):self.state.currentPage>=self.state.lastPage-w?(start=self.state.lastPage-8,content=this.getPageRange(start,self.state.lastPage),this.getStart()+content):(content=this.getAdjacentRange(),this.getStart()+content+this.getFinish())},getLink:function(page){return'<a href="'+self.getPaginatorUrl(page,!0)+'" data-page="'+page+'">'+page+"</a>"},getAdjacentRange:function(){return start=self.state.currentPage-3,this.getPageRange(start,self.state.currentPage+3)},getStart:function(){return this.getPageRange(1,2)+this.getDots()},getFinish:function(){var content=this.getPageRange(self.state.lastPage-1,self.state.lastPage);return this.getDots()+content},getDots:function(){return'<li class="disabled"><a href="#">...</a></li>'}});this.presenter=new View}});return PageableCollection});